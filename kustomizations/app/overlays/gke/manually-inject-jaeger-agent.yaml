##
##
##

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: adservice
  annotations:
    linkerd.io/inject: enabled
spec:
  template:
    metadata:
      annotations:
        linkerd.io/inject: enabled
        config.linkerd.io/trace-collector: linkerd-collector.linkerd:55678
        config.alpha.linkerd.io/trace-collector-service-account: linkerd-collector
    spec:
      containers:
      - name: server
        env:
        - name: JAEGER_SERVICE_ADDR
          value: "127.0.0.1:14268"
        # - name: DISABLE_STATS
        #   value: "1"
        # - name: DISABLE_TRACING
        #   value: "1"
      - name: jaeger-agent
        image: jaegertracing/jaeger-opentelemetry-agent:latest
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 5778
          name: http-config-ag
          protocol: TCP
        - containerPort: 6831
          name: jg-compact-trft
          protocol: UDP
        - containerPort: 6832
          name: jg-binary-trft
          protocol: UDP
        - containerPort: 14268
          name: http-traces
          protocol: TCP
        - containerPort: 14250
          name: grpc-traces
          protocol: TCP
        env:
        - name: SERVICE_NAME
          value: adservice
        - name: K8S_NAMESPACE_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: K8S_CLUSTER_NAME
          value: k8s
        - name: K8S_POD_UID
          valueFrom:
            fieldRef:
              fieldPath: metadata.uid
        - name: K8S_POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: K8S_POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        - name: HOST_IP
          valueFrom:
            fieldRef:
              fieldPath: status.hostIP
        - name: HOST_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        args: [
          --http-server.host-port=:5778,
          --collector.grpc-server.host-port=:14250,
          --collector.http-server.host-port=:14268,
          --processor.jaeger-binary.server-host-port=:6832,
          --processor.jaeger-compact.server-host-port=:6831,
          --reporter.grpc.host-port=dns:///jaeger-collector-headless.monitoring.svc.cluster.local:14250,
          "--resource.attributes=service.instance.id=$(K8S_POD_NAME),k8s.pod.name=$(K8S_POD_NAME),k8s.pod.uid=$(K8S_POD_UID),k8s.namespace.name=$(K8S_NAMESPACE_NAME),k8s.pod.ip=$(K8S_POD_IP),k8s.cluster.name=$(K8S_CLUSTER_NAME),host.name=$(HOST_NAME),host.ip=$(HOST_IP),cloud.provider=gcp,cloud.region=europe-west1"
        ]
        securityContext:
          capabilities:
            drop:
            - ALL
          readOnlyRootFilesystem: true
          runAsUser: 65532
          runAsGroup: 65532
          runAsNonRoot: true
        resources:
          requests:
            cpu: 5m
            memory: 10Mi
          limits:
            cpu: 50m
            memory: 100Mi

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: cartservice
  annotations:
    linkerd.io/inject: enabled


---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: checkoutservice
  annotations:
    linkerd.io/inject: enabled
spec:
  template:
    metadata:
      annotations:
        linkerd.io/inject: enabled
        config.linkerd.io/trace-collector: linkerd-collector.linkerd:55678
        config.alpha.linkerd.io/trace-collector-service-account: linkerd-collector
    spec:
      containers:
      - name: server
        env:
        - name: JAEGER_SERVICE_ADDR
          value: "127.0.0.1:14268"
        # - name: DISABLE_STATS
        #   value: "1"
        # - name: DISABLE_TRACING
        #   value: "1"
      - name: jaeger-agent
        image: jaegertracing/jaeger-opentelemetry-agent:latest
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 5778
          name: http-config-ag
          protocol: TCP
        - containerPort: 6831
          name: jg-compact-trft
          protocol: UDP
        - containerPort: 6832
          name: jg-binary-trft
          protocol: UDP
        - containerPort: 14268
          name: http-traces
          protocol: TCP
        - containerPort: 14250
          name: grpc-traces
          protocol: TCP
        env:
        - name: SERVICE_NAME
          value: checkoutservice
        - name: K8S_NAMESPACE_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: K8S_CLUSTER_NAME
          value: k8s
        - name: K8S_POD_UID
          valueFrom:
            fieldRef:
              fieldPath: metadata.uid
        - name: K8S_POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: K8S_POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        - name: HOST_IP
          valueFrom:
            fieldRef:
              fieldPath: status.hostIP
        - name: HOST_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        args: [
          --http-server.host-port=:5778,
          --collector.grpc-server.host-port=:14250,
          --collector.http-server.host-port=:14268,
          --processor.jaeger-binary.server-host-port=:6832,
          --processor.jaeger-compact.server-host-port=:6831,
          --reporter.grpc.host-port=dns:///jaeger-collector-headless.monitoring.svc.cluster.local:14250,
          "--resource.attributes=service.instance.id=$(K8S_POD_NAME),k8s.pod.name=$(K8S_POD_NAME),k8s.pod.uid=$(K8S_POD_UID),k8s.namespace.name=$(K8S_NAMESPACE_NAME),k8s.pod.ip=$(K8S_POD_IP),k8s.cluster.name=$(K8S_CLUSTER_NAME),host.name=$(HOST_NAME),host.ip=$(HOST_IP),cloud.provider=gcp,cloud.region=europe-west1"
        ]
        securityContext:
          capabilities:
            drop:
            - ALL
          readOnlyRootFilesystem: true
          runAsUser: 65532
          runAsGroup: 65532
          runAsNonRoot: true
        resources:
          requests:
            cpu: 5m
            memory: 10Mi
          limits:
            cpu: 50m
            memory: 100Mi

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: currencyservice
  annotations:
    linkerd.io/inject: enabled
spec:
  template:
    metadata:
      annotations:
        linkerd.io/inject: enabled
        config.linkerd.io/trace-collector: linkerd-collector.linkerd:55678
        config.alpha.linkerd.io/trace-collector-service-account: linkerd-collector
    spec:
      containers:
      - name: server
        env:
        - name: DISABLE_PROFILER
          value: "1"
        # - name: DISABLE_TRACING
        #   value: "1"
        # - name: DISABLE_DEBUGGER
        #   value: "1"
      - name: jaeger-agent
        image: jaegertracing/jaeger-opentelemetry-agent:latest
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 5778
          name: http-config-ag
          protocol: TCP
        - containerPort: 6831
          name: jg-compact-trft
          protocol: UDP
        - containerPort: 6832
          name: jg-binary-trft
          protocol: UDP
        - containerPort: 14268
          name: http-traces
          protocol: TCP
        - containerPort: 14250
          name: grpc-traces
          protocol: TCP
        env:
        - name: SERVICE_NAME
          value: currencyservice
        - name: K8S_NAMESPACE_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: K8S_CLUSTER_NAME
          value: k8s
        - name: K8S_POD_UID
          valueFrom:
            fieldRef:
              fieldPath: metadata.uid
        - name: K8S_POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: K8S_POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        - name: HOST_IP
          valueFrom:
            fieldRef:
              fieldPath: status.hostIP
        - name: HOST_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        args: [
          --http-server.host-port=:5778,
          --collector.grpc-server.host-port=:14250,
          --collector.http-server.host-port=:14268,
          --processor.jaeger-binary.server-host-port=:6832,
          --processor.jaeger-compact.server-host-port=:6831,
          --reporter.grpc.host-port=dns:///jaeger-collector-headless.monitoring.svc.cluster.local:14250,
          "--resource.attributes=service.instance.id=$(K8S_POD_NAME),k8s.pod.name=$(K8S_POD_NAME),k8s.pod.uid=$(K8S_POD_UID),k8s.namespace.name=$(K8S_NAMESPACE_NAME),k8s.pod.ip=$(K8S_POD_IP),k8s.cluster.name=$(K8S_CLUSTER_NAME),host.name=$(HOST_NAME),host.ip=$(HOST_IP),cloud.provider=gcp,cloud.region=europe-west1"
        ]
        securityContext:
          capabilities:
            drop:
            - ALL
          readOnlyRootFilesystem: true
          runAsUser: 65532
          runAsGroup: 65532
          runAsNonRoot: true
        resources:
          requests:
            cpu: 5m
            memory: 10Mi
          limits:
            cpu: 50m
            memory: 100Mi

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: emailservice
  annotations:
    linkerd.io/inject: enabled
spec:
  template:
    metadata:
      annotations:
        linkerd.io/inject: enabled
        config.linkerd.io/trace-collector: linkerd-collector.linkerd:55678
        config.alpha.linkerd.io/trace-collector-service-account: linkerd-collector
    spec:
      containers:
      - name: server
        env:
        - name: DISABLE_PROFILER
          value: "1"
        # - name: DISABLE_TRACING
        #   value: "1"

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: frontend
  annotations:
    linkerd.io/inject: enabled
spec:
  template:
    metadata:
      annotations:
        linkerd.io/inject: enabled
        config.linkerd.io/trace-collector: linkerd-collector.linkerd:55678
        config.alpha.linkerd.io/trace-collector-service-account: linkerd-collector
    spec:
      containers:
      - name: server
        env:
        - name: ENV_PLATFORM
          value: gcp
        - name: JAEGER_SERVICE_ADDR
          value: "127.0.0.1:14268"
        # - name: DISABLE_TRACING
        #   value: "1"
        - name: DISABLE_PROFILER
          value: "1"
      - name: jaeger-agent
        image: jaegertracing/jaeger-opentelemetry-agent:latest
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 5778
          name: http-config-ag
          protocol: TCP
        - containerPort: 6831
          name: jg-compact-trft
          protocol: UDP
        - containerPort: 6832
          name: jg-binary-trft
          protocol: UDP
        - containerPort: 14268
          name: http-traces
          protocol: TCP
        - containerPort: 14250
          name: grpc-traces
          protocol: TCP
        env:
        - name: SERVICE_NAME
          value: frontend
        - name: K8S_NAMESPACE_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: K8S_CLUSTER_NAME
          value: k8s
        - name: K8S_POD_UID
          valueFrom:
            fieldRef:
              fieldPath: metadata.uid
        - name: K8S_POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: K8S_POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        - name: HOST_IP
          valueFrom:
            fieldRef:
              fieldPath: status.hostIP
        - name: HOST_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        args: [
          --http-server.host-port=:5778,
          --collector.grpc-server.host-port=:14250,
          --collector.http-server.host-port=:14268,
          --processor.jaeger-binary.server-host-port=:6832,
          --processor.jaeger-compact.server-host-port=:6831,
          --reporter.grpc.host-port=dns:///jaeger-collector-headless.monitoring.svc.cluster.local:14250,
          "--resource.attributes=service.instance.id=$(K8S_POD_NAME),k8s.pod.name=$(K8S_POD_NAME),k8s.pod.uid=$(K8S_POD_UID),k8s.namespace.name=$(K8S_NAMESPACE_NAME),k8s.pod.ip=$(K8S_POD_IP),k8s.cluster.name=$(K8S_CLUSTER_NAME),host.name=$(HOST_NAME),host.ip=$(HOST_IP),cloud.provider=gcp,cloud.region=europe-west1"
        ]
        securityContext:
          capabilities:
            drop:
            - ALL
          readOnlyRootFilesystem: true
          runAsUser: 65532
          runAsGroup: 65532
          runAsNonRoot: true
        resources:
          requests:
            cpu: 5m
            memory: 10Mi
          limits:
            cpu: 50m
            memory: 100Mi

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: paymentservice
  annotations:
    linkerd.io/inject: enabled


---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: productcatalogservice
  annotations:
    linkerd.io/inject: enabled
spec:
  template:
    metadata:
      annotations:
        linkerd.io/inject: enabled
        config.linkerd.io/trace-collector: linkerd-collector.linkerd:55678
        config.alpha.linkerd.io/trace-collector-service-account: linkerd-collector
    spec:
      containers:
      - name: server
        env:
        - name: JAEGER_SERVICE_ADDR
          value: "127.0.0.1:14268"
        # - name: DISABLE_STATS
        #   value: "1"
        # - name: DISABLE_TRACING
        #   value: "1"
        - name: DISABLE_PROFILER
          value: "1"
      - name: jaeger-agent
        image: jaegertracing/jaeger-opentelemetry-agent:latest
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 5778
          name: http-config-ag
          protocol: TCP
        - containerPort: 6831
          name: jg-compact-trft
          protocol: UDP
        - containerPort: 6832
          name: jg-binary-trft
          protocol: UDP
        - containerPort: 14268
          name: http-traces
          protocol: TCP
        - containerPort: 14250
          name: grpc-traces
          protocol: TCP
        env:
        - name: SERVICE_NAME
          value: productcatalogservice
        - name: K8S_NAMESPACE_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: K8S_CLUSTER_NAME
          value: k8s
        - name: K8S_POD_UID
          valueFrom:
            fieldRef:
              fieldPath: metadata.uid
        - name: K8S_POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: K8S_POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        - name: HOST_IP
          valueFrom:
            fieldRef:
              fieldPath: status.hostIP
        - name: HOST_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        args: [
          --http-server.host-port=:5778,
          --collector.grpc-server.host-port=:14250,
          --collector.http-server.host-port=:14268,
          --processor.jaeger-binary.server-host-port=:6832,
          --processor.jaeger-compact.server-host-port=:6831,
          --reporter.grpc.host-port=dns:///jaeger-collector-headless.monitoring.svc.cluster.local:14250,
          "--resource.attributes=service.instance.id=$(K8S_POD_NAME),k8s.pod.name=$(K8S_POD_NAME),k8s.pod.uid=$(K8S_POD_UID),k8s.namespace.name=$(K8S_NAMESPACE_NAME),k8s.pod.ip=$(K8S_POD_IP),k8s.cluster.name=$(K8S_CLUSTER_NAME),host.name=$(HOST_NAME),host.ip=$(HOST_IP),cloud.provider=gcp,cloud.region=europe-west1"
        ]
        securityContext:
          capabilities:
            drop:
            - ALL
          readOnlyRootFilesystem: true
          runAsUser: 65532
          runAsGroup: 65532
          runAsNonRoot: true
        resources:
          requests:
            cpu: 5m
            memory: 10Mi
          limits:
            cpu: 50m
            memory: 100Mi

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: recommendationservice
  annotations:
    linkerd.io/inject: enabled
spec:
  template:
    metadata:
      annotations:
        linkerd.io/inject: enabled
        config.linkerd.io/trace-collector: linkerd-collector.linkerd:55678
        config.alpha.linkerd.io/trace-collector-service-account: linkerd-collector
    spec:
      containers:
      - name: server
        env:
        - name: DISABLE_PROFILER
          value: "1"
        # - name: DISABLE_TRACING
        #   value: "1"
        # - name: DISABLE_DEBUGGER
        #   value: "1"
      - name: jaeger-agent
        image: jaegertracing/jaeger-opentelemetry-agent:latest
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 5778
          name: http-config-ag
          protocol: TCP
        - containerPort: 6831
          name: jg-compact-trft
          protocol: UDP
        - containerPort: 6832
          name: jg-binary-trft
          protocol: UDP
        - containerPort: 14268
          name: http-traces
          protocol: TCP
        - containerPort: 14250
          name: grpc-traces
          protocol: TCP
        env:
        - name: SERVICE_NAME
          value: recommendationservice
        - name: K8S_NAMESPACE_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: K8S_CLUSTER_NAME
          value: k8s
        - name: K8S_POD_UID
          valueFrom:
            fieldRef:
              fieldPath: metadata.uid
        - name: K8S_POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: K8S_POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        - name: HOST_IP
          valueFrom:
            fieldRef:
              fieldPath: status.hostIP
        - name: HOST_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        args: [
          --http-server.host-port=:5778,
          --collector.grpc-server.host-port=:14250,
          --collector.http-server.host-port=:14268,
          --processor.jaeger-binary.server-host-port=:6832,
          --processor.jaeger-compact.server-host-port=:6831,
          --reporter.grpc.host-port=dns:///jaeger-collector-headless.monitoring.svc.cluster.local:14250,
          "--resource.attributes=service.instance.id=$(K8S_POD_NAME),k8s.pod.name=$(K8S_POD_NAME),k8s.pod.uid=$(K8S_POD_UID),k8s.namespace.name=$(K8S_NAMESPACE_NAME),k8s.pod.ip=$(K8S_POD_IP),k8s.cluster.name=$(K8S_CLUSTER_NAME),host.name=$(HOST_NAME),host.ip=$(HOST_IP),cloud.provider=gcp,cloud.region=europe-west1"
        ]
        securityContext:
          capabilities:
            drop:
            - ALL
          readOnlyRootFilesystem: true
          runAsUser: 65532
          runAsGroup: 65532
          runAsNonRoot: true
        resources:
          requests:
            cpu: 5m
            memory: 10Mi
          limits:
            cpu: 50m
            memory: 100Mi

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: shippingservice
  annotations:
    linkerd.io/inject: enabled
spec:
  template:
    metadata:
      annotations:
        linkerd.io/inject: enabled
        config.linkerd.io/trace-collector: linkerd-collector.linkerd:55678
        config.alpha.linkerd.io/trace-collector-service-account: linkerd-collector
    spec:
      containers:
      - name: server
        env:
        - name: JAEGER_SERVICE_ADDR
          value: "127.0.0.1:14268"
        # - name: DISABLE_STATS
        #   value: "1"
        # - name: DISABLE_TRACING
        #   value: "1"
        - name: DISABLE_PROFILER
          value: "1"
      - name: jaeger-agent
        image: jaegertracing/jaeger-opentelemetry-agent:latest
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 5778
          name: http-config-ag
          protocol: TCP
        - containerPort: 6831
          name: jg-compact-trft
          protocol: UDP
        - containerPort: 6832
          name: jg-binary-trft
          protocol: UDP
        - containerPort: 14268
          name: http-traces
          protocol: TCP
        - containerPort: 14250
          name: grpc-traces
          protocol: TCP
        env:
        - name: SERVICE_NAME
          value: shippingservice
        - name: K8S_NAMESPACE_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: K8S_CLUSTER_NAME
          value: k8s
        - name: K8S_POD_UID
          valueFrom:
            fieldRef:
              fieldPath: metadata.uid
        - name: K8S_POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: K8S_POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        - name: HOST_IP
          valueFrom:
            fieldRef:
              fieldPath: status.hostIP
        - name: HOST_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        args: [
          --http-server.host-port=:5778,
          --collector.grpc-server.host-port=:14250,
          --collector.http-server.host-port=:14268,
          --processor.jaeger-binary.server-host-port=:6832,
          --processor.jaeger-compact.server-host-port=:6831,
          --reporter.grpc.host-port=dns:///jaeger-collector-headless.monitoring.svc.cluster.local:14250,
          "--resource.attributes=service.instance.id=$(K8S_POD_NAME),k8s.pod.name=$(K8S_POD_NAME),k8s.pod.uid=$(K8S_POD_UID),k8s.namespace.name=$(K8S_NAMESPACE_NAME),k8s.pod.ip=$(K8S_POD_IP),k8s.cluster.name=$(K8S_CLUSTER_NAME),host.name=$(HOST_NAME),host.ip=$(HOST_IP),cloud.provider=gcp,cloud.region=europe-west1"
        ]
        securityContext:
          capabilities:
            drop:
            - ALL
          readOnlyRootFilesystem: true
          runAsUser: 65532
          runAsGroup: 65532
          runAsNonRoot: true
        resources:
          requests:
            cpu: 5m
            memory: 10Mi
          limits:
            cpu: 50m
            memory: 100Mi
